# План разработки MVP FinanceBot

**Цель:** Создать MVP телеграм-бота для трекинга финансов с использованием AI (NLP/STT) согласно спецификациям в `docs/product.md` и `docs/tech.md`.

**Стек:** Python 3.11+, aiogram 3.x, SQLAlchemy (Async), SQLite, OpenAI/DeepSeek API.

## Этапы реализации

### Шаг 1. Инициализация проекта и настройка окружения
- [ ] Создать базовую структуру проекта (`/handlers`, `/services`, `/database`, `/core`).
- [ ] Настроить управление зависимостями (создать `requirements.txt` или `pyproject.toml`): `aiogram`, `sqlalchemy`, `aiosqlite`, `alembic`, `pydantic-settings`, `openai`.
- [ ] Настроить конфигурацию через Pydantic (`core/config.py`) и `.env`.
- [ ] Настроить базовое логгирование.

### Шаг 2. Слой данных (Database Layer)
*Согласно `docs/tech.md` используем SQLAlchemy + Alembic.*
- [ ] Настроить подключение к SQLite (асинхронный движок).
- [ ] Создать модели данных:
    - `User` (telegram_id, registered_at, settings).
    - `Transaction` (user_id, amount, category, raw_text, date).
- [ ] Инициализировать Alembic и создать первую миграцию.
- [ ] Реализовать базовые репозитории (`BaseRepository`, `UserRepository`, `TransactionRepository`) с методами CRUD.

### Шаг 3. AI Сервис (Logic Layer)
- [ ] Создать `AIService` (`services/ai_service.py`).
- [ ] Реализовать метод `parse_transaction_text(text: str) -> TransactionDTO`:
    - Подготовить системный промпт для извлечения JSON (сумма, категория, дата).
    - Интеграция с OpenAI API (или DeepSeek).
- [ ] Реализовать метод `transcribe_audio(file_path: str) -> str`:
    - Интеграция с Whisper API для STT.

### Шаг 4. Финансовый сервис (Logic Layer)
- [ ] Создать `FinanceService` (`services/finance_service.py`).
- [ ] Реализовать логику добавления транзакции (валидация, вызов репозитория).
- [ ] Реализовать логику получения статистики (за неделю, по категориям).

### Шаг 5. Интерфейс бота (Telegram Layer)
- [ ] Настроить `Bot` и `Dispatcher` (`main.py`).
- [ ] Реализовать `start_handler`: регистрация пользователя в БД.
- [ ] Реализовать обработку текстовых сообщений:
    - Вызов `AIService` для парсинга.
    - Вызов `FinanceService` для сохранения.
    - Ответ пользователю.
- [ ] Реализовать обработку голосовых сообщений:
    - Скачивание файла.
    - Транскрибация.
    - Далее как с текстом.
- [ ] Реализовать команду `/stats` или `/week` для отчетов.

### Шаг 6. Тестирование и Документация
- [ ] Провести ручное тестирование основных сценариев (текст, голос, ошибки распознавания).
- [ ] Обновить README.md инструкцией по запуску.
- [ ] Проверить соответствие документации в `docs/`.

## Риски
1.  **Галлюцинации LLM:** Бот может неправильно определить сумму или категорию.
    *   *Mitigation:* Добавить шаг подтверждения или возможность редактирования (в v2), для MVP — четкий промпт.
2.  **API Costs:** Использование OpenAI на каждое сообщение может быть дорогим.
    *   *Mitigation:* Использовать `gpt-4o-mini` или DeepSeek для экономии.
3.  **Проблемы с STT:** Голосовые могут плохо распознаваться в шуме.

## Стратегия отката
- В случае критических ошибок в БД — откат миграций через Alembic.
- При проблемах с API провайдером — возможность смены `base_url` и `model` через `.env`.

